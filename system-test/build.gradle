apply plugin: 'java'

dependencies {

    compile project(':scheduler')

    testCompile 'junit:junit:4.11'
    testCompile 'com.github.docker-java:docker-java:1.3.0'
    testCompile 'com.mashape.unirest:unirest-java:1.4.5'
    testCompile 'com.jayway.awaitility:awaitility:1.6.3'
}

test {
    exclude '**/*SystemTest*'
}

task mkImagesDir {

    def folder = new File("${project.buildDir}/test/images")

    if (!folder.exists()) {
        folder.mkdirs()
    }

}

task saveExecutor(type: Exec, dependsOn: [ 'mkImagesDir' /*, ':executor:docker' */ ]) {
    commandLine 'docker', 'save', '-o', "${project.rootProject.buildDir}/test/images/executor.tar", 'mesos/elasticsearch-executor'
}

task dockerComposeUp(type: Exec, dependsOn: saveExecutor) {

    commandLine 'docker-compose', '-f', "${project.projectDir}/src/test/resources/mesos-es/docker-compose.yml", 'up', '-d'

}

//dockerComposeUp.dependsOn project.rootProject.tasks.withType(DockerBuildImage)
//dockerComposeUp.dependsOn ":scheduler:docker" 

task dockerComposeKill(type: Exec) {

    commandLine 'docker-compose', '-f', "${project.projectDir}/src/test/resources/mesos-es/docker-compose.yml", 'kill'

}

task dockerComposeRm(type: Exec) {

    commandLine 'docker-compose', '-f', "${project.projectDir}/src/test/resources/mesos-es/docker-compose.yml", 'rm', '--force', '-v'

}

dockerComposeKill.finalizedBy dockerComposeRm

task systemTest(type: Test) {
    include '**/*SystemTest*'
    testLogging {
        showStandardStreams = true
    }
    outputs.upToDateWhen { false }
}

systemTest.dependsOn dockerComposeUp
systemTest.finalizedBy dockerComposeKill
